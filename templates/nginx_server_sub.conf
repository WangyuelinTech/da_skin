|?DOCROOT=`HOME`/domains/`DOMAIN`/public_html|
|?SDOCROOT=`DOCROOT`/`SUB`|
|?REALDOCROOT=`HOME`/domains/`DOMAIN`/public_html/`SUB`|
|?OPEN_BASEDIR_PATH=`HOME`/:/tmp:/var/tmp:/usr/local/lib/php/|
server
{
|CUSTOM|

	listen |IP|:|PORT_80|;
	|MULTI_IP|

	server_name |SUB|.|DOMAIN| www.|SUB|.|DOMAIN|;

	access_log /var/log/nginx/domains/|DOMAIN|.|SUB|.log;
	access_log /var/log/nginx/domains/|DOMAIN|.|SUB|.bytes bytes;
	error_log /var/log/nginx/domains/|DOMAIN|.|SUB|.error.log;
  
	root |SDOCROOT|;
  
	index index.php index.html index.htm;

	|*if HAVE_PHP1_FPM="1"|
		# use fastcgi for all php files
		location ~ \.php$
		{
			try_files $uri =404;
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			include /etc/nginx/fastcgi_params;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; 

			if (-f $request_filename)
			{
				fastcgi_pass unix:/usr/local/php|PHP1_RELEASE|/sockets/|USER|.sock;
			}
		}
	|*endif|
	|*if HAVE_PHP2_FPM="1"|
		# use fastcgi for all php files
		location ~ \.php|PHP2_RELEASE|$
		{
			try_files $uri =404;
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			include /etc/nginx/fastcgi_params;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; 

			if (-f $request_filename)
			{
				fastcgi_pass unix:/usr/local/php|PHP2_RELEASE|/sockets/|USER|.sock;
			}
		}
	|*endif|

	# deny access to apache .htaccess files
	location ~ /\.ht
	{
		deny all;
	}

        location /squirrelmail {
               root /var/www/html/;
               index index.php index.html index.htm;
               location ~ ^/squirrelmail/(.+\.php)$ {
                       try_files $uri =404;
                       root /var/www/html/;
                       fastcgi_pass unix:/usr/local/php|PHP1_RELEASE|/sockets/webapps.sock;
                       fastcgi_index index.php;
                       fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                       include /etc/nginx/fastcgi_params;
                       fastcgi_buffer_size 128k;
                       fastcgi_buffers 256 4k;
                       fastcgi_busy_buffers_size 256k;
                       fastcgi_temp_file_write_size 256k;
                       fastcgi_intercept_errors on;
               }
               location ~* ^/squirrelmail/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
                       root /var/www/html/;
               }
        }

        location /roundcube {
               root /var/www/html/;
               index index.php index.html index.htm;
               location ~ ^/roundcube/(.+\.php)$ {
                       try_files $uri =404;
                       root /var/www/html/;
                       fastcgi_pass unix:/usr/local/php|PHP1_RELEASE|/sockets/webapps.sock;
                       fastcgi_index index.php;
                       fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                       include /etc/nginx/fastcgi_params;
                       fastcgi_buffer_size 128k;
                       fastcgi_buffers 256 4k;
                       fastcgi_busy_buffers_size 256k;
                       fastcgi_temp_file_write_size 256k;
                       fastcgi_intercept_errors on;
               }
               location ~* ^/roundcube/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
                       root /var/www/html/;
               }
        }

        location /phpMyAdmin {
               root /var/www/html/;
               index index.php index.html index.htm;
               location ~ ^/phpMyAdmin/(.+\.php)$ {
                       try_files $uri =404;
                       root /var/www/html/;
                       fastcgi_pass unix:/usr/local/php|PHP1_RELEASE|/sockets/webapps.sock;
                       fastcgi_index index.php;
                       fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                       include /etc/nginx/fastcgi_params;
                       fastcgi_buffer_size 128k;
                       fastcgi_buffers 256 4k;
                       fastcgi_busy_buffers_size 256k;
                       fastcgi_temp_file_write_size 256k;
                       fastcgi_intercept_errors on;
               }
               location ~* ^/phpMyAdmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
                       root /var/www/html/;
               }
        }

        location /phpmyadmin {
               rewrite ^/* /phpMyAdmin last;
        }

        location /pma {
               rewrite ^/* /phpMyAdmin last;
        }

        location /webmail {
               rewrite ^/* /roundcube last;
        }
}
